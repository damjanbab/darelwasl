# System report — 2025-12-14

## Dead code
- `src/darelwasl/entity.clj:16` and `src/darelwasl/entity.clj:23` define `pull-by-type`/`ensure-type` but nothing calls them; they can be deleted or wired into callers instead of bespoke queries.
- `src/darelwasl/ui/entity.cljs:62` `list-key` is unused; list rendering already pulls keys directly from `entity-view-config`.
- Several public-site render helpers are orphaned: `render-licenses` (`src/darelwasl/site/http.clj:269`), `render-pillars` (`src/darelwasl/site/http.clj:318`), `render-proof-section` (`src/darelwasl/site/http.clj:392`), and `render-personas` (`src/darelwasl/site/http.clj:460`). None are referenced in the site assembly, so they are dead weight and drift-prone.

## DRY mistakes
- Input normalization/validation is duplicated between `src/darelwasl/tasks.clj:49-134` and `src/darelwasl/content.clj:19-109` (string/uuid/boolean/keyword handling, param-value helpers). Divergence risks inconsistent error messages and behavior; extract to a shared validation namespace.
- Allowed block types are hardcoded twice: backend `src/darelwasl/content.clj:143` and frontend `src/darelwasl/app.cljs:106`. A single shared source (e.g., registry-driven or CLJC constant) would prevent mismatches.
- Pagination/meta-string assembly is reimplemented in multiple UIs (e.g., `src/darelwasl/features/tasks.cljs` and both lists in `src/darelwasl/features/land.cljs:34-119`). A shared paginator component or helper would reduce copy/paste bugs.

## KISS mistakes
- Task listing pulls every task eid and filters in-memory (`src/darelwasl/tasks.clj:424-454`), ignoring Datomic-side filtering/pagination. This is O(n) per request and drifts from the documented server-side pagination contract.
- `task-eid` (`src/darelwasl/tasks.clj:196-239`) rescans the entire DB and string-compares IDs when a lookup misses, adding complexity and latency instead of enforcing consistent UUID storage.
- Land APIs (`src/darelwasl/land.clj:132-200`) fully load people/parcels/ownerships every time, then filter/sort client-side. This will not scale beyond the sample dataset and contradicts the pagination guardrails in `docs/system.md`.
- UI components dispatch side effects directly from render bodies (e.g., `src/darelwasl/features/home.cljs:29-30` and `src/darelwasl/features/land.cljs:168-172`), which is against re-frame’s event model and risks double-firing when renders re-run.

## Inconsistent architectural patterns (incl. data)
- `registries/actions.edn` closes the top-level vector at `registries/actions.edn:355` and then starts new action maps outside any collection. `edn/read` only returns the first form, so all content/public-site actions after that point are omitted from registry-driven tooling—violating the “single canonical registry” rule.
- `registries/views.edn` repeats the same mistake: the vector ends at `registries/views.edn:112`, and public-site views starting at `registries/views.edn:113` sit outside it. Registry readers only see the first block, so site capabilities are effectively unregistered.
- Checks in `scripts/checks.sh` parse registries with `edn/read`, which silently ignores trailing forms. The malformed registries above therefore pass gating while silently dropping capabilities, breaking the contract described in `docs/system.md`.

## Overengineering
- The public-site server (`src/darelwasl/site/http.clj`) hand-builds large HTML strings for many section types, yet several of those renderers are unused. This string-templating approach is hard to test, bypasses the shared UI/theming layer, and bloats the namespace without delivering behavior.
- Dual startup paths (`src/darelwasl/main.clj` vs `src/darelwasl/site/main.clj`) duplicate DB prep/backfill/seed logic verbatim. A shared bootstrap would reduce maintenance overhead.

## Composability opportunities
- Centralize request param normalization and error construction so actions (tasks/content/land) share the same contracts and messages; makes it easier to compose new actions without reimplementing validation.
- Move capability lists (e.g., block types, status/priority enums) into registries and generate both backend/CLJS constants from them to keep contracts composable and flaggable.
- Introduce query helpers that enforce server-side filtering/pagination for Datomic lists; consumers could compose filters without reloading the entire dataset each time.

## Reusability opportunities
- The control panel forms for pages/blocks/tags and v2 entities (`src/darelwasl/features/control_panel.cljs`) repeat form grids, success/error banners, and new/edit toggles. A reusable detail-form shell would cut duplication and keep future content entities consistent.
- Pagination bars/meta strings are hand-written per list; a single reusable paginator component could be shared by tasks, land, and control panel lists.
- Entity render configs exist in `src/darelwasl/ui/entity.cljs` but are underused; extending them and consuming in all lists/detail panes would standardize list rows and keys while reducing bespoke UI code.
